<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
		/>
		<title>GAuth 迁移助手 Pro (全能版)</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link
			href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<style>
			:root {
				--primary: #4f46e5;
				--primary-hover: #4338ca;
				--success: #10b981;
				--error: #ef4444;
				--bg-body: #f8fafc;
				--bg-surface: #ffffff;
				--text-main: #0f172a;
				--text-sub: #64748b;
				--border: #e2e8f0;
				--radius-lg: 16px;
				--radius-md: 12px;
				--shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
				--shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
			}
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			body {
				font-family: "Plus Jakarta Sans", sans-serif;
				background: var(--bg-body);
				color: var(--text-main);
				min-height: 100vh;
				display: flex;
				flex-direction: column;
			}

			/* Nav */
			nav {
				position: sticky;
				top: 0;
				z-index: 50;
				background: rgba(255, 255, 255, 0.85);
				backdrop-filter: blur(12px);
				border-bottom: 1px solid var(--border);
				height: 64px;
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 0 1.5rem;
			}
			.nav-inner {
				width: 100%;
				max-width: 1000px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.brand {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				font-weight: 700;
				font-size: 1.1rem;
			}
			.brand-icon {
				width: 32px;
				height: 32px;
				background: linear-gradient(135deg, #4f46e5, #818cf8);
				border-radius: 8px;
				display: grid;
				place-items: center;
				color: white;
			}

			/* Main */
			main {
				flex: 1;
				width: 100%;
				max-width: 1000px;
				margin: 0 auto;
				padding: 2rem 1.5rem;
				display: flex;
				flex-direction: column;
				gap: 1.5rem;
			}

			/* Upload */
			.upload-section {
				background: var(--bg-surface);
				border: 2px dashed var(--border);
				border-radius: var(--radius-lg);
				padding: 3rem 1.5rem;
				text-align: center;
				transition: 0.2s;
				cursor: pointer;
			}
			.upload-section:hover {
				border-color: var(--primary);
				background: #f5f3ff;
				transform: translateY(-2px);
			}
			.upload-content h2 {
				margin-bottom: 0.5rem;
				font-weight: 700;
			}
			.upload-content p {
				color: var(--text-sub);
				margin-bottom: 1.5rem;
				font-size: 0.9rem;
			}

			/* Buttons */
			.btn {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				gap: 0.5rem;
				padding: 0.6rem 1.2rem;
				border-radius: 10px;
				font-weight: 600;
				font-size: 0.875rem;
				transition: 0.2s;
				cursor: pointer;
				border: 1px solid transparent;
			}
			.btn-primary {
				background: var(--primary);
				color: white;
				box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
			}
			.btn-primary:hover:not(:disabled) {
				background: var(--primary-hover);
				transform: translateY(-1px);
			}
			.btn-primary:disabled {
				background: #94a3b8;
				cursor: not-allowed;
				box-shadow: none;
			}
			.btn-secondary {
				background: white;
				border-color: var(--border);
				color: var(--text-main);
			}
			.btn-secondary:hover {
				border-color: #cbd5e1;
				background: #f1f5f9;
			}
			.btn-block {
				width: 100%;
				padding: 12px;
				justify-content: space-between;
			} /* Export menu items */

			/* Grid */
			.grid-container {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
				gap: 1rem;
			}
			.card {
				background: white;
				border: 1px solid var(--border);
				border-radius: var(--radius-md);
				padding: 1.25rem;
				position: relative;
				transition: 0.2s;
				display: flex;
				flex-direction: column;
				gap: 1rem;
			}
			.card:hover {
				border-color: #cbd5e1;
				box-shadow: var(--shadow-sm);
				transform: translateY(-2px);
			}
			.card-header {
				display: flex;
				gap: 1rem;
				align-items: flex-start;
			}
			.service-icon {
				width: 42px;
				height: 42px;
				background: #f8fafc;
				border-radius: 10px;
				display: grid;
				place-items: center;
				border: 1px solid var(--border);
				color: var(--text-sub);
				flex-shrink: 0;
			}
			.card-info {
				flex: 1;
				min-width: 0;
			}
			.card-title {
				font-weight: 700;
				margin-bottom: 2px;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			.card-subtitle {
				font-size: 0.8rem;
				color: var(--text-sub);
				display: block;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			.tags {
				display: flex;
				gap: 6px;
				margin-top: 6px;
			}
			.tag {
				font-size: 0.7rem;
				padding: 2px 8px;
				border-radius: 6px;
				background: #f1f5f9;
				border: 1px solid var(--border);
				color: var(--text-sub);
				font-weight: 600;
			}
			.tag.totp {
				background: #eff6ff;
				color: var(--primary);
				border-color: #c7d2fe;
			}

			.delete-btn {
				position: absolute;
				top: 1rem;
				right: 1rem;
				background: none;
				border: none;
				color: #94a3b8;
				cursor: pointer;
				padding: 4px;
				border-radius: 4px;
			}
			.delete-btn:hover {
				background: #fef2f2;
				color: var(--error);
			}

			/* Stats Bar */
			.stats-bar {
				display: flex;
				justify-content: space-between;
				align-items: center;
				background: white;
				padding: 1rem;
				border-radius: var(--radius-md);
				border: 1px solid var(--border);
				box-shadow: var(--shadow-sm);
			}
			.hidden {
				display: none !important;
			}

			/* Modals */
			.modal-overlay {
				position: fixed;
				inset: 0;
				background: rgba(0, 0, 0, 0.5);
				backdrop-filter: blur(4px);
				z-index: 100;
				display: flex;
				justify-content: center;
				align-items: center;
				opacity: 0;
				visibility: hidden;
				transition: 0.2s;
			}
			.modal-overlay.show {
				opacity: 1;
				visibility: visible;
			}
			.modal {
				background: white;
				width: 90%;
				max-width: 450px;
				padding: 1.5rem;
				border-radius: 16px;
				box-shadow: var(--shadow-lg);
				transform: scale(0.95);
				transition: 0.2s;
			}
			.modal-overlay.show .modal {
				transform: scale(1);
			}

			/* Export Menu */
			.export-option {
				display: flex;
				align-items: center;
				gap: 1rem;
				padding: 1rem;
				border: 1px solid var(--border);
				border-radius: 10px;
				margin-bottom: 0.75rem;
				cursor: pointer;
				transition: 0.2s;
				text-align: left;
				background: white;
				width: 100%;
			}
			.export-option:hover {
				border-color: var(--primary);
				background: #f5f3ff;
			}
			.export-icon {
				width: 36px;
				height: 36px;
				background: #e0e7ff;
				color: var(--primary);
				border-radius: 8px;
				display: grid;
				place-items: center;
				flex-shrink: 0;
			}
			.export-info h4 {
				margin: 0 0 2px 0;
				font-size: 0.95rem;
			}
			.export-info p {
				margin: 0;
				font-size: 0.8rem;
				color: var(--text-sub);
			}

			/* Progress */
			.progress-bar {
				height: 6px;
				background: #f1f5f9;
				border-radius: 99px;
				overflow: hidden;
				margin-top: 8px;
			}
			.progress-fill {
				height: 100%;
				background: var(--primary);
				width: 0%;
				transition: width 0.3s;
			}

			/* Toast */
			.toast-container {
				position: fixed;
				bottom: 20px;
				right: 20px;
				z-index: 200;
				display: flex;
				flex-direction: column;
				gap: 10px;
			}
			.toast {
				background: white;
				padding: 12px 16px;
				border-radius: 10px;
				border: 1px solid var(--border);
				box-shadow: var(--shadow-lg);
				display: flex;
				align-items: center;
				gap: 10px;
				animation: slideIn 0.3s;
				font-size: 0.9rem;
				font-weight: 500;
			}
			.toast.success {
				border-left: 4px solid var(--success);
			}
			.toast.error {
				border-left: 4px solid var(--error);
			}
			@keyframes slideIn {
				from {
					transform: translateY(20px);
					opacity: 0;
				}
				to {
					transform: translateY(0);
					opacity: 1;
				}
			}

			@media (max-width: 640px) {
				.stats-bar {
					flex-direction: column;
					align-items: stretch;
					gap: 1rem;
				}
			}
		</style>
	</head>
	<body>
		<nav>
			<div class="nav-inner">
				<div class="brand">
					<div class="brand-icon">
						<svg
							width="20"
							height="20"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2.5"
						>
							<path
								d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"
							/>
						</svg>
					</div>
					GAuth 迁移助手 Pro
				</div>
				<button
					class="btn btn-primary"
					id="exportMenuBtn"
					disabled
					onclick="openModal('exportModal')"
				>
					<span>导出数据</span>
					<svg
						width="16"
						height="16"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
					>
						<path d="M6 9l6 6 6-6" />
					</svg>
				</button>
			</div>
		</nav>

		<main>
			<div class="upload-section" id="dropZone">
				<input
					type="file"
					id="fileInput"
					accept="image/*"
					multiple
					hidden
				/>
				<div class="upload-content">
					<div
						style="
							width: 64px;
							height: 64px;
							background: #eff6ff;
							color: #4f46e5;
							border-radius: 20px;
							display: grid;
							place-items: center;
							margin: 0 auto 1.25rem auto;
							box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.1);
						"
					>
						<svg
							width="32"
							height="32"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
						>
							<path
								d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"
							/>
							<path d="M12 8v4" />
							<path d="M12 16h.01" />
						</svg>
					</div>

					<h2
						style="
							color: var(--text-main);
							letter-spacing: -0.025em;
						"
					>
						Google Authenticator 纯本地化迁移
					</h2>

					<p
						style="
							max-width: 400px;
							margin: 0.5rem auto 1.5rem auto;
							line-height: 1.6;
						"
					>
						<span style="color: var(--success); font-weight: 600"
							>全程浏览器离线处理</span
						>、双引擎解析、自动增强去噪、支持批量处理
					</p>
					<div
						style="
							display: flex;
							gap: 10px;
							justify-content: center;
						"
					>
						<button
							class="btn btn-primary"
							onclick="document.getElementById('fileInput').click()"
						>
							选择图片
						</button>
						<button
							class="btn btn-secondary"
							onclick="openModal('manualModal')"
						>
							链接解析
						</button>
					</div>
				</div>
			</div>

			<div class="stats-bar hidden" id="statsBar">
				<div style="font-weight: 600">
					已解析
					<span id="countDisplay" style="color: var(--primary)"
						>0</span
					>
					个账户
				</div>
				<div style="display: flex; gap: 10px">
					<input
						type="text"
						id="searchInput"
						placeholder="搜索..."
						style="
							padding: 8px 12px;
							border: 1px solid var(--border);
							border-radius: 8px;
							outline: none;
						"
					/>
					<button
						class="btn btn-secondary"
						onclick="confirmClearAll()"
					>
						清空
					</button>
				</div>
			</div>

			<div class="grid-container" id="gridContainer"></div>
			<div
				id="emptyState"
				style="text-align: center; padding: 3rem; color: #94a3b8"
			>
				暂无数据
			</div>
		</main>

		<div class="modal-overlay" id="exportModal">
			<div class="modal">
				<div
					style="
						display: flex;
						justify-content: space-between;
						margin-bottom: 1.5rem;
						align-items: center;
					"
				>
					<h3 style="margin: 0">选择导出格式</h3>
					<button
						onclick="closeModal('exportModal')"
						style="
							background: none;
							border: none;
							font-size: 1.5rem;
							color: var(--text-sub);
							cursor: pointer;
						"
					>
						&times;
					</button>
				</div>

				<button class="export-option" onclick="exportData('bitwarden')">
					<div class="export-icon">
						<svg
							width="20"
							height="20"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
						>
							<path
								d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"
							/>
						</svg>
					</div>
					<div class="export-info">
						<h4>Bitwarden (JSON)</h4>
						<p>适用于 Bitwarden, Vaultwarden 导入</p>
					</div>
				</button>

				<button class="export-option" onclick="exportData('csv')">
					<div class="export-icon">
						<svg
							width="20"
							height="20"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
						>
							<path
								d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
							/>
							<polyline points="14 2 14 8 20 8" />
							<line x1="16" y1="13" x2="8" y2="13" />
							<line x1="16" y1="17" x2="8" y2="17" />
							<polyline points="10 9 9 9 8 9" />
						</svg>
					</div>
					<div class="export-info">
						<h4>通用 CSV</h4>
						<p>适用于 1Password, KeePass, Enpass, LastPass</p>
					</div>
				</button>

				<button class="export-option" onclick="exportData('txt')">
					<div class="export-icon">
						<svg
							width="20"
							height="20"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
						>
							<line x1="8" y1="6" x2="21" y2="6" />
							<line x1="8" y1="12" x2="21" y2="12" />
							<line x1="8" y1="18" x2="21" y2="18" />
							<line x1="3" y1="6" x2="3.01" y2="6" />
							<line x1="3" y1="12" x2="3.01" y2="12" />
							<line x1="3" y1="18" x2="3.01" y2="18" />
						</svg>
					</div>
					<div class="export-info">
						<h4>纯 URI 文本 (.txt)</h4>
						<p>适用于 Aegis, 2FAS 或生成新二维码 (万能格式)</p>
					</div>
				</button>
			</div>
		</div>

		<div class="modal-overlay" id="progressModal">
			<div class="modal" style="text-align: center">
				<h3 style="margin-bottom: 0.5rem">正在处理</h3>
				<p
					id="progressText"
					style="
						color: var(--text-sub);
						font-size: 0.9rem;
						margin-bottom: 10px;
					"
				>
					初始化...
				</p>
				<div class="progress-bar">
					<div class="progress-fill" id="progressFill"></div>
				</div>
			</div>
		</div>

		<div class="modal-overlay" id="manualModal">
			<div class="modal">
				<div
					style="
						display: flex;
						justify-content: space-between;
						margin-bottom: 1rem;
					"
				>
					<h3>手动解析</h3>
					<button
						onclick="closeModal('manualModal')"
						style="
							background: none;
							border: none;
							font-size: 1.2rem;
							cursor: pointer;
						"
					>
						✕
					</button>
				</div>
				<textarea
					id="manualInput"
					style="
						width: 100%;
						height: 120px;
						border: 1px solid var(--border);
						border-radius: 10px;
						padding: 12px;
						font-family: monospace;
						font-size: 0.85rem;
						resize: vertical;
					"
					placeholder="粘贴 otpauth-migration://..."
				></textarea>
				<button
					class="btn btn-primary"
					style="width: 100%; margin-top: 1rem"
					onclick="processManual()"
				>
					确认解析
				</button>
			</div>
		</div>

		<div class="toast-container" id="toastContainer"></div>

		<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

		<script>
			// === State ===
			let state = { accounts: [] };

			// === Icons ===
			const ICONS = {
				github: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>',
				google: '<svg viewBox="0 0 24 24"><path fill="#EA4335" d="M12 5.04c1.86 0 3.52.66 4.82 1.88l3.6-3.6C18.24 1.24 15.34 0 12 0 7.4 0 3.38 2.64 1.43 6.53l4.2 3.26C6.6 6.86 9.07 5.04 12 5.04z"/><path fill="#34A853" d="M24 12.3c0-.85-.08-1.67-.22-2.46H12v4.66h6.76c-.3 1.54-1.16 2.84-2.47 3.72l3.98 3.09c2.32-2.14 3.67-5.29 3.67-9.01z"/><path fill="#4A90E2" d="M4.33 14.54c-.26-.77-.41-1.6-.41-2.46s.15-1.69.41-2.46L.13 6.36A11.96 11.96 0 0 0 0 12c0 1.98.48 3.86 1.33 5.54l4.33-3.26z"/><path fill="#FBBC05" d="M12 24c3.24 0 5.86-1.07 7.84-2.9l-3.98-3.09c-1.07.72-2.44 1.14-3.86 1.14-2.93 0-5.41-1.98-6.3-4.64l-4.2 3.26C3.38 21.36 7.4 24 12 24z"/></svg>',
				aws: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.9 8.4c-1.9 0-3.3.4-3.3 2.7v.1c0 1.9 1.4 2.5 3.1 2.5 1.4 0 2.5-.5 2.5-1.9v-2c-.7-.9-1.5-1.4-2.3-1.4zm6.6-4.9c-.8-.4-1.7-.5-2.6-.5-3.3 0-5.3 1.7-6.1 4.2-1-.7-2.3-1.1-3.6-1.1-3.6 0-6 2.5-6 6.2 0 2.8 1.6 5 4.3 5 1.7 0 3-.6 3.9-1.8.3 1.1 1.3 1.7 2.6 1.7.9 0 1.8-.3 2.5-.7v-3.7c-.8.5-1.5.7-2.1.7-.6 0-1-.3-1-1v-4.9c0-2 .9-2.8 2.5-2.8.5 0 1 .1 1.4.3v-1.6z"/></svg>',
				default:
					'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
			};

			// === DOM Events ===
			const dropZone = document.getElementById("dropZone");
			const fileInput = document.getElementById("fileInput");

			dropZone.addEventListener("dragover", (e) => {
				e.preventDefault();
				dropZone.style.borderColor = "var(--primary)";
				dropZone.style.background = "#f5f3ff";
			});
			dropZone.addEventListener("dragleave", () => {
				dropZone.style.borderColor = "var(--border)";
				dropZone.style.background = "var(--bg-surface)";
			});
			dropZone.addEventListener("drop", (e) => {
				e.preventDefault();
				dropZone.style.borderColor = "var(--border)";
				dropZone.style.background = "var(--bg-surface)";
				if (e.dataTransfer.files.length)
					handleBatchFiles(e.dataTransfer.files);
			});
			fileInput.addEventListener("change", (e) => {
				if (e.target.files.length) handleBatchFiles(e.target.files);
				fileInput.value = "";
			});
			document
				.getElementById("searchInput")
				.addEventListener("input", (e) => renderGrid(e.target.value));

			// === Core: Batch Processing ===
			async function handleBatchFiles(fileList) {
				openModal("progressModal");
				const files = Array.from(fileList);
				const total = files.length;
				let success = 0,
					fail = 0;

				for (let i = 0; i < total; i++) {
					const file = files[i];
					updateProgress(i + 1, total, file.name);
					try {
						const rawText = await decodeViolently(file);
						const newAcc = parseProtobuf(rawText);
						mergeAccounts(newAcc);
						success++;
					} catch (e) {
						console.error(e);
						fail++;
					}
					await new Promise((r) => setTimeout(r, 50));
				}

				setTimeout(() => {
					closeModal("progressModal");
					renderGrid();
					if (success > 0)
						showToast(
							`完成：成功 ${success} 张，失败 ${fail} 张`,
							fail > 0 ? "error" : "success"
						);
					else showToast(`解析失败，请尝试手动输入`, "error");
				}, 500);
			}

			// === Core: Decoding (Hybrid Engine) ===
			async function decodeViolently(file) {
				const img = await loadImage(file);
				const strategies = [
					{ name: "Raw", fn: null },
					{
						name: "Bin-128",
						fn: (ctx, w, h) => filterBinarize(ctx, w, h, 128),
					},
					{
						name: "Invert",
						fn: (ctx, w, h) => filterInvert(ctx, w, h),
					},
					{ name: "Scale-2x", scale: 2, fn: null },
					{
						name: "Bin-100",
						fn: (ctx, w, h) => filterBinarize(ctx, w, h, 100),
					},
				];
				const zxing = new ZXing.BrowserMultiFormatReader();

				for (const strat of strategies) {
					try {
						const canvas = document.createElement("canvas");
						const scale = strat.scale || 1;
						canvas.width = img.width * scale;
						canvas.height = img.height * scale;
						const ctx = canvas.getContext("2d");
						ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
						if (strat.fn)
							strat.fn(ctx, canvas.width, canvas.height);
						const imgData = ctx.getImageData(
							0,
							0,
							canvas.width,
							canvas.height
						);

						if (window.jsQR) {
							const code = jsQR(
								imgData.data,
								canvas.width,
								canvas.height
							);
							if (code) return code.data;
						}
						const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
						const res = await zxing.decodeFromImage(
							undefined,
							dataUrl
						);
						if (res) return res.text;
					} catch (e) {
						continue;
					}
				}

				if ("BarcodeDetector" in window) {
					try {
						const det = new BarcodeDetector({
							formats: ["qr_code"],
						});
						const bars = await det.detect(img);
						if (bars.length) return bars[0].rawValue;
					} catch (e) {}
				}
				throw new Error("Failed");
			}

			function loadImage(file) {
				return new Promise((r, j) => {
					const u = URL.createObjectURL(file);
					const i = new Image();
					i.onload = () => {
						URL.revokeObjectURL(u);
						r(i);
					};
					i.onerror = j;
					i.src = u;
				});
			}
			function filterBinarize(ctx, w, h, t) {
				const d = ctx.getImageData(0, 0, w, h);
				for (let i = 0; i < d.data.length; i += 4) {
					const v =
						0.299 * d.data[i] +
							0.587 * d.data[i + 1] +
							0.114 * d.data[i + 2] >=
						t
							? 255
							: 0;
					d.data[i] = d.data[i + 1] = d.data[i + 2] = v;
				}
				ctx.putImageData(d, 0, 0);
			}
			function filterInvert(ctx, w, h) {
				const d = ctx.getImageData(0, 0, w, h);
				for (let i = 0; i < d.data.length; i += 4) {
					d.data[i] = 255 - d.data[i];
					d.data[i + 1] = 255 - d.data[i + 1];
					d.data[i + 2] = 255 - d.data[i + 2];
				}
				ctx.putImageData(d, 0, 0);
			}

			// === Core: Protobuf ===
			function parseProtobuf(urlStr) {
				if (!urlStr.includes("otpauth-migration"))
					throw new Error("Format error");
				let b64 = "";
				try {
					b64 = new URL(urlStr).searchParams.get("data");
				} catch {
					b64 = urlStr.split("data=")[1]?.split("&")[0];
				}
				if (!b64) throw new Error("No data");
				b64 = decodeURIComponent(b64)
					.replace(/-/g, "+")
					.replace(/_/g, "/");
				const bin = atob(b64);
				const bytes = new Uint8Array(bin.length);
				for (let i = 0; i < bin.length; i++)
					bytes[i] = bin.charCodeAt(i);

				const list = [];
				let ptr = 0;
				const readVarint = () => {
					let r = 0,
						s = 0,
						b;
					do {
						b = bytes[ptr++];
						r |= (b & 0x7f) << s;
						s += 7;
					} while (b & 0x80);
					return r;
				};

				while (ptr < bytes.length) {
					const k = readVarint();
					const f = k >> 3;
					const t = k & 7;
					if (f === 1 && t === 2) {
						const len = readVarint();
						const end = ptr + len;
						const item = { algo: "SHA1", digits: 6, type: "totp" };
						while (ptr < end) {
							const pk = readVarint();
							const pf = pk >> 3;
							const pt = pk & 7;
							if (pt === 2) {
								const pl = readVarint();
								const val = bytes.slice(ptr, ptr + pl);
								ptr += pl;
								const txt = new TextDecoder().decode(val);
								if (pf === 1) {
									const a =
										"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
									let bs = 0,
										v = 0,
										out = "";
									for (const b of val) {
										v = (v << 8) | b;
										bs += 8;
										while (bs >= 5) {
											out += a[(v >>> (bs - 5)) & 31];
											bs -= 5;
										}
									}
									if (bs > 0) out += a[(v << (5 - bs)) & 31];
									item.secret = out;
								} else if (pf === 2) item.name = txt;
								else if (pf === 3) item.issuer = txt;
								else if (pf === 4) item.algo = txt;
							} else if (pt === 0) {
								const val = readVarint();
								if (pf === 4)
									item.algo =
										{
											1: "SHA1",
											2: "SHA256",
											3: "SHA512",
											4: "MD5",
										}[val] || "SHA1";
								else if (pf === 5)
									item.digits = val === 2 ? 8 : 6;
								else if (pf === 6)
									item.type = val === 1 ? "hotp" : "totp";
							} else {
								if (pt === 2) ptr += readVarint();
								else if (pt === 0) readVarint();
								else if (pt === 5) ptr += 4;
								else if (pt === 1) ptr += 8;
							}
						}
						if (item.secret) list.push(item);
					} else {
						if (t === 2) ptr += readVarint();
						else if (t === 0) readVarint();
						else if (t === 5) ptr += 4;
						else if (t === 1) ptr += 8;
					}
				}
				return list;
			}

			// === UI Logic ===
			function mergeAccounts(newItems) {
				const existing = new Set(state.accounts.map((a) => a.secret));
				newItems.forEach((item) => {
					if (!existing.has(item.secret)) state.accounts.push(item);
				});
			}

			function renderGrid(filter = "") {
				const div = document.getElementById("gridContainer");
				div.innerHTML = "";
				const f = filter.toLowerCase();
				const list = state.accounts
					.map((acc, i) => ({ acc, i }))
					.filter(
						(o) =>
							(o.acc.name || "").toLowerCase().includes(f) ||
							(o.acc.issuer || "").toLowerCase().includes(f)
					);

				document
					.getElementById("statsBar")
					.classList.toggle("hidden", state.accounts.length === 0);
				document.getElementById("emptyState").style.display =
					state.accounts.length === 0 ? "block" : "none";
				document.getElementById("countDisplay").textContent =
					state.accounts.length;
				document.getElementById("exportMenuBtn").disabled =
					state.accounts.length === 0;

				list.forEach(({ acc, i }) => {
					const card = document.createElement("div");
					card.className = "card";
					card.innerHTML = `
                <button class="delete-btn" onclick="removeAccount(${i})">✕</button>
                <div class="card-header">
                    <div class="service-icon">${getIcon(acc)}</div>
                    <div class="card-info">
                        <div class="card-title" title="${esc(acc.name)}">${esc(
						acc.name
					)}</div>
                        <div class="card-subtitle">${esc(
							acc.issuer || "Unknown"
						)}</div>
                        <div class="tags"><span class="tag totp">${acc.type.toUpperCase()}</span><span class="tag">${
						acc.algo
					}</span><span class="tag">${acc.digits}位</span></div>
                    </div>
                </div>
            `;
					div.appendChild(card);
				});
			}

			// === Exports ===
			function generateUri(acc) {
				const name = acc.issuer
					? `${acc.issuer}:${acc.name}`
					: acc.name;
				return `otpauth://${acc.type}/${encodeURIComponent(
					name
				)}?secret=${acc.secret}&issuer=${encodeURIComponent(
					acc.issuer || ""
				)}&digits=${acc.digits}&algorithm=${acc.algo}&period=30`;
			}

			window.exportData = (type) => {
				let content, mime, name;
				const date = new Date().toISOString().slice(0, 10);

				if (type === "bitwarden") {
					const items = state.accounts.map((acc) => ({
						type: 1,
						name: acc.issuer
							? `${acc.issuer}: ${acc.name}`
							: acc.name,
						login: { totp: generateUri(acc) },
					}));
					content = JSON.stringify(
						{ encrypted: false, items },
						null,
						2
					);
					mime = "application/json";
					name = `bitwarden_export_${date}.json`;
				} else if (type === "csv") {
					const headers =
						"name,secret,issuer,type,algorithm,digits,period,uri\n";
					const rows = state.accounts
						.map((acc) => {
							const n = `"${(acc.name || "").replace(
								/"/g,
								'""'
							)}"`;
							const i = `"${(acc.issuer || "").replace(
								/"/g,
								'""'
							)}"`;
							return `${n},${acc.secret},${i},${acc.type},${
								acc.algo
							},${acc.digits},30,"${generateUri(acc)}"`;
						})
						.join("\n");
					content = headers + rows;
					mime = "text/csv";
					name = `otp_export_${date}.csv`;
				} else if (type === "txt") {
					content = state.accounts
						.map((acc) => generateUri(acc))
						.join("\n");
					mime = "text/plain";
					name = `otp_uris_${date}.txt`;
				}

				const blob = new Blob([content], { type: mime });
				const a = document.createElement("a");
				a.href = URL.createObjectURL(blob);
				a.download = name;
				a.click();
				closeModal("exportModal");
				showToast("导出成功", "success");
			};

			// === Utils ===
			window.removeAccount = (i) => {
				if (confirm("确定删除？")) {
					state.accounts.splice(i, 1);
					renderGrid();
				}
			};
			window.confirmClearAll = () => {
				if (confirm("确定清空？")) {
					state.accounts = [];
					renderGrid();
				}
			};
			window.openModal = (id) =>
				document.getElementById(id).classList.add("show");
			window.closeModal = (id) =>
				document.getElementById(id).classList.remove("show");
			window.processManual = () => {
				const v = document.getElementById("manualInput").value.trim();
				if (!v) return;
				try {
					mergeAccounts(parseProtobuf(v));
					renderGrid();
					closeModal("manualModal");
					showToast("解析成功", "success");
				} catch (e) {
					showToast("格式无效", "error");
				}
			};
			function updateProgress(i, t, msg) {
				document.getElementById("progressFill").style.width =
					Math.round((i / t) * 100) + "%";
				document.getElementById(
					"progressText"
				).textContent = `处理中 ${i}/${t}: ${msg}`;
			}
			function showToast(msg, type) {
				const t = document.createElement("div");
				t.className = `toast ${type}`;
				t.textContent = msg;
				document.getElementById("toastContainer").appendChild(t);
				setTimeout(() => t.remove(), 3000);
			}
			function getIcon(acc) {
				const k = (acc.issuer + acc.name).toLowerCase();
				if (k.includes("git")) return ICONS.github;
				if (k.includes("goog")) return ICONS.google;
				if (k.includes("aws")) return ICONS.aws;
				return ICONS.default;
			}
			function esc(s) {
				return s ? s.replace(/&/g, "&amp;").replace(/</g, "&lt;") : "";
			}
		</script>
	</body>
</html>
